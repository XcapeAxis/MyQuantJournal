# 2026Q1_mom项目全链路标准化实现计划

## 目标
让2026Q1_mom的全链路满足三条硬标准：
1. Universe一致：bars更新、rank生成、回测三处使用同一份Universe
2. 过滤强制生效：无论DB里有什么股票，最终都只会用board=mainboard且is_st=false的代码集合
3. 实验可追溯：每次rank/回测运行会落一个run_manifest.json

## 实现步骤

### Task A：把Universe“变成唯一真相来源”

#### A1. 约定Universe文件路径与字段
- 输入：`data/meta/symbols.csv`
- 必需列：code, is_st, board（name可选但建议保留）
- 类型容错：is_st可能是FALSE/TRUE字符串、0/1、false/true，需要统一解析成布尔

#### A2. 创建可复用的Universe过滤函数
- 过滤规则：
  - board == "mainboard"
  - is_st == False
  - 排除300/301/688/689/8xx/4xx前缀（以防symbols.csv出错）
- 函数名：`filter_universe`
- 输入：symbols_df（pandas DataFrame）
- 输出：过滤后的symbols_df

#### A3. 产出冻结后的universe列表
- 输出：`data/projects/2026Q1_mom/meta/universe_codes.txt`
- 内容：过滤后的code列表（每行一个6位代码）
- 作用：后续任何环节都可以直接读取这个冻结列表，确保一致性

### Task B：bars更新脚本只更新Universe

#### B1. 修改11_update_bars.py的输入
- 不再从Akshare拉全市场codes后自己过滤
- 改为：读取`data/meta/symbols.csv`过滤后列表或`data/projects/2026Q1_mom/meta/universe_codes.txt`

#### B2. registry.csv与universe的关系
- registry.csv依然可用，但需要确保：registry只维护universe的codes
- 如果universe发生变化，更新脚本需要：
  - 新codes自动加入registry（last_date为空）
  - 不在universe的codes不再更新（可保留旧记录但不再触碰）

### Task C：Rank生成必须基于Universe

#### C1. Rank生成时的codes来源
- 唯一来源：`data/projects/2026Q1_mom/meta/universe_codes.txt`
- 禁止：直接SELECT DISTINCT symbol FROM bars ...当作universe

#### C2. 动量定义
- mom_20d = close / close.shift(20) - 1
- rebalance_dates：每5个交易日一次（用交易日历）

#### C3. 输出位置
- data/projects/2026Q1_mom/signals/rank_top5.parquet
- 列：date, code, score, rank

### Task D：添加实验清单run_manifest.json

- 路径：`data/projects/2026Q1_mom/meta/run_manifest.json`
- 包含内容：
  - project：2026Q1_mom
  - generated_at：时间戳
  - git_commit：当前commit hash
  - config_path + 配置内容摘要
  - db_path + freq
  - universe_size + universe_sha256
  - data_date_range（DB中实际覆盖的起止日期）
  - rank_path、plot_path

### Task E：回测结果补可信指标

- 计算指标：
  - 最大回撤（MDD）
  - 年化收益与年化波动
  - 换手率
- 输出到：`artifacts/projects/2026Q1_mom/summary_metrics.csv`

## 实现顺序

1. 首先实现Task A，确保Universe成为唯一真相来源
2. 然后实现Task C，确保Rank生成基于Universe
3. 接着实现Task B，确保bars更新只使用Universe
4. 然后实现Task D，添加run_manifest.json
5. 最后实现Task E，添加回测指标

## 关键文件修改

1. `scripts/steps/10_symbols.py`：添加Universe过滤函数，生成冻结列表
2. `scripts/steps/11_update_bars.py`：修改数据源，添加run_manifest生成
3. `scripts/steps/20_make_weights_mom.py`：修改为使用冻结Universe
4. 新增脚本：用于生成run_manifest.json
5. 扩展回测逻辑，添加指标计算

## 验收标准

- Universe一致：三处使用同一份Universe
- 过滤强制生效：最终只会用board=mainboard且is_st=false的代码集合
- 实验可追溯：每次运行生成run_manifest.json
- 性能指标完善：包含MDD、年化收益、年化波动、换手率

这个计划确保了2026Q1_mom项目的全链路满足三条硬标准，同时提高了项目的可追溯性和可维护性。